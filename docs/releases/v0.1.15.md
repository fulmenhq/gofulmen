# Release v0.1.15 - Logging Redaction Middleware + Repository Root Discovery

**Release Date**: 2025-11-16  
**Release Type**: Major Feature Release  
**Status**: ✅ Ready for Release

## Overview

This release adds schema-compliant logging redaction middleware for PII/secrets protection and repository root discovery for pathfinder. The redaction middleware enables automatic filtering of sensitive data in logs per Crucible v0.2.16, while repository root discovery fixes schema validation from test subdirectories and provides a foundation for tooling that needs repository context.

### Key Highlights

- **Logging Redaction Middleware**: Schema-compliant PII and secrets filtering with pattern and field-based redaction
- **Repository Root Discovery**: Safe upward traversal with multiple safety boundaries and security protections
- **Schema Validator Fixes**: Path resolution from repository root fixes test subdirectory issues
- **Crucible v0.2.16 Update**: Latest Crucible release with logging middleware and pathfinder specifications
- **Cross-Language Parity**: Symlink loop detection aligned with tsfulmen v0.1.9
- **100% Backward Compatibility**: All logging configurations work without changes

## What's New

### Logging Redaction Middleware

Schema-compliant middleware for automatically filtering sensitive data from logs.

#### Features

- **Pattern-Based Redaction**: Regular expressions for API keys, tokens, passwords, SSNs, credit cards
- **Field-Based Redaction**: Specific field names (password, token, secret, apiKey, ssn, creditCard)
- **Replacement Modes**: Text (`[REDACTED]`) or hash (SHA-256 prefix for traceability)
- **Opt-In Design**: No behavioral changes unless explicitly configured
- **Crucible v0.2.16 Compliance**: Middleware `type` and `priority` fields per specification
- **Backward Compatible**: Legacy `name`→`type`, `order`→`priority` field mapping

#### Usage Examples

**Simple Redaction (Defaults)**:

```go
import "github.com/fulmenhq/gofulmen/logging"

// Create logger with default redaction patterns and fields
logger, err := logging.BundleStructuredWithRedaction()
if err != nil {
    log.Fatal(err)
}

// Automatically redacts sensitive data
logger.Info("User login", map[string]any{
    "username": "alice",
    "password": "secret123",  // Redacted: [REDACTED]
    "apiKey": "sk_live_abc123", // Redacted: [REDACTED]
})
```

**Custom Redaction**:

```go
import "github.com/fulmenhq/gofulmen/logging"

// Configure custom redaction patterns and fields
redactionConfig := logging.RedactionConfig{
    Patterns: []string{
        `\b[A-Z0-9]{20,}\b`,  // Long alphanumeric tokens
        `credit_card=\d{16}`,  // Credit card numbers
    },
    Fields: []string{"ssn", "tax_id", "internal_token"},
    ReplacementMode: "hash",  // Use hash prefix instead of [REDACTED]
}

logger, err := logging.New(logging.LoggingConfig{
    Profile: "STRUCTURED",
    MinSeverity: "INFO",
    Middleware: []logging.MiddlewareConfig{
        logging.WithRedaction(redactionConfig),
    },
})
```

**YAML Configuration**:

```yaml
profile: STRUCTURED
min_severity: INFO
middleware:
  - type: redaction # or name: redaction (backward compatible)
    priority: 100 # or order: 100 (backward compatible)
    config:
      patterns:
        - '\b[A-Z0-9]{20,}\b'
        - 'Bearer\s+[A-Za-z0-9\-._~+/]+'
      fields:
        - password
        - apiKey
        - secret
      replacement_mode: text # or "hash"
```

#### Default Patterns

The middleware includes default patterns for common sensitive data:

- **API Keys**: `sk_live_[a-zA-Z0-9]+`, `pk_live_[a-zA-Z0-9]+`
- **Tokens**: `Bearer\s+[A-Za-z0-9\-._~+/]+`, `ghp_[a-zA-Z0-9]+`
- **Passwords**: `password["\s:=]+[^\s"]+`
- **Social Security Numbers**: `\b\d{3}-\d{2}-\d{4}\b`
- **Credit Cards**: `\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b`

#### Default Fields

- `password`, `token`, `secret`, `apiKey`, `api_key`
- `ssn`, `social_security_number`
- `creditCard`, `credit_card`, `ccNumber`, `cc_number`

### Pathfinder Repository Root Discovery

Safe upward traversal for detecting repository roots with comprehensive security protections.

#### Features

- **FindRepositoryRoot() API**: Safe upward traversal per Crucible v0.2.15 specification
- **Predefined Marker Sets**: Git (`.git`), Go (`go.mod`), Node (`package.json`), Python (`pyproject.toml`), Monorepo (`pnpm-workspace.yaml`)
- **Safety Boundaries**: Home directory ceiling (default), configurable boundaries, max depth (10)
- **Filesystem Root Detection**: `/` (Unix), `C:\` (Windows), UNC paths (`\\server\share`)
- **Symlink Loop Detection**: `TRAVERSAL_LOOP` error with critical severity (cross-language parity with tsfulmen)
- **Security Boundaries**: Multi-tenant isolation, container escape prevention
- **Performance**: <30µs for all operations (well under Crucible spec targets)

#### Usage Examples

**Basic Repository Root Discovery**:

```go
import "github.com/fulmenhq/gofulmen/pathfinder"

// Find repository root from current directory
rootPath, err := pathfinder.FindRepositoryRoot(".")
if err != nil {
    log.Fatal(err)
}
fmt.Printf("Repository root: %s\n", rootPath)
```

**Custom Markers and Boundaries**:

```go
import "github.com/fulmenhq/gofulmen/pathfinder"

// Find repository root with custom configuration
opts := []pathfinder.RootOption{
    pathfinder.WithMarkers([]string{".git", "go.mod", "package.json"}),
    pathfinder.WithMaxDepth(5),
    pathfinder.WithBoundary("/home/user/projects"),  // Don't search above this
}

rootPath, err := pathfinder.FindRepositoryRoot("/home/user/projects/myapp/src", opts...)
if err != nil {
    if errors.Is(err, pathfinder.ErrRepositoryNotFound) {
        fmt.Println("No repository found within boundaries")
    }
    log.Fatal(err)
}
```

**Symlink Following with Loop Detection**:

```go
import "github.com/fulmenhq/gofulmen/pathfinder"

// Follow symlinks with automatic loop detection
opts := []pathfinder.RootOption{
    pathfinder.WithFollowSymlinks(true),
    pathfinder.WithMarkers(pathfinder.GitMarkers),
}

rootPath, err := pathfinder.FindRepositoryRoot("/path/with/symlinks", opts...)
if err != nil {
    if errors.Is(err, pathfinder.ErrTraversalLoop) {
        fmt.Println("Symlink loop detected")
    }
    log.Fatal(err)
}
```

#### Predefined Marker Sets

- **GitMarkers**: `.git`
- **GoModMarkers**: `go.mod`
- **NodeMarkers**: `package.json`, `pnpm-workspace.yaml`, `lerna.json`
- **PythonMarkers**: `pyproject.toml`, `setup.py`
- **MonorepoMarkers**: `pnpm-workspace.yaml`, `lerna.json`, `nx.json`

#### Safety Boundaries

1. **Home Directory Ceiling**: Default boundary prevents traversal above `$HOME`
2. **Filesystem Root Detection**: Stops at `/`, `C:\`, or UNC path roots
3. **Max Depth Limit**: Default 10 levels prevents runaway traversal
4. **Configurable Boundaries**: Custom paths for multi-tenant environments
5. **Symlink Loop Detection**: Tracks visited real paths to prevent infinite loops

### Schema Validator Fixes

Fixed path resolution issues when running tests from subdirectories.

#### Changes

- **Repository Root Resolution**: Added `findRepoRoot()` helper to compute paths from repository root
- **Fixed Path Mapping**: `mapSchemaURLToPath()` now handles relative schema references correctly
- **Version Directory Detection**: Prevents duplicate path segments (e.g., `/v1.0.0/v1.0.0/`)
- **Subdirectory Testing**: All schema validation tests pass from any subdirectory

#### Impact

- ✅ Schema validation works correctly from test subdirectories
- ✅ Relative schema references (e.g., `severity-filter.schema.json`) resolve properly
- ✅ Version directory detection prevents path issues
- ✅ No changes required to existing code using schema validator

### Crucible v0.2.16 Update

Updated from Crucible v0.2.15 → v0.2.16 with full verification.

**What Changed**:

- **Logging Schemas**: Updated with middleware `type` and `priority` fields
- **Pathfinder Spec**: Added repository root discovery specification
- **ADR-0012**: New schema reference IDs standard
- **DevSecOps Taxonomy**: Updated with modules schema
- **Metrics Taxonomy**: Latest definitions

**Verification Process**:

1. Updated `go.mod` and `go.sum` with v0.2.16 hashes
2. Updated `.goneat/ssot-consumer.yaml` sync configuration to use v0.2.16 ref
3. Ran `make sync` to pull new assets
4. Verified all tests pass with new Crucible version
5. Confirmed precommit checks pass with 0 issues

## Test Coverage

### Comprehensive Test Suite

**Logging Middleware**:

- Backward compatibility tests (name→type, order→priority mapping)
- Redaction pattern tests (API keys, passwords, SSNs, credit cards)
- Field-based redaction tests
- Replacement mode tests (text vs hash)
- Helper function tests (WithRedaction, BundleSimpleWithRedaction, etc.)

**Pathfinder Repository Root Discovery** (36 tests total):

- **Basic Functionality** (9 tests): Marker detection, max depth, boundary enforcement
- **Security Tests** (17 tests): Home directory boundary, multi-tenant isolation, container escape prevention, symlink attacks, loop detection
- **Performance Benchmarks** (10 tests): Immediate match, 3 levels up, 5 levels up, max depth

**Schema Validator**:

- Path resolution from subdirectories
- Relative schema reference handling
- Version directory detection
- All existing schema validation tests

### Security Test Coverage

**Critical Security Tests**:

1. ✅ Home directory boundary enforcement (prevents root traversal)
2. ✅ Explicit boundaries prevent access outside designated areas
3. ✅ Max depth prevents runaway traversal
4. ✅ Multi-tenant isolation (cross-tenant data access prevented)
5. ✅ Container escape prevention
6. ✅ CI workspace isolation (cross-job leakage prevented)
7. ✅ Symlink attack prevention (boundaries enforced even with follow)
8. ✅ Symlink loop detection (TRAVERSAL_LOOP error)
9. ✅ Filesystem root detection (/, C:\, UNC)
10. ✅ Edge cases (empty paths, invalid markers, etc.)

### Performance Results

All benchmarks well under Crucible spec targets:

- **Immediate match**: 6.0µs (target: <5ms) - **830x faster** ✅
- **3 levels up**: 13.6µs (target: <5ms) - **367x faster** ✅
- **5 levels up**: 18.0µs (target: <20ms) - **1,111x faster** ✅
- **Max depth (10)**: 30.0µs (target: <20ms) - **666x faster** ✅

## Files Changed

**Logging Middleware** (6 files):

```
logging/middleware_redaction_v2.go       # NEW: 241 lines - Redaction middleware
logging/helpers.go                        # NEW: 78 lines - Helper functions
logging/config.go                         # Modified: +25 lines - RedactionConfig, MiddlewareConfig
logging/logger.go                         # Modified: +56 lines - Pipeline builder compatibility
logging/logger_test.go                    # Modified: +7 lines - Test updates
logging/config_test.go                    # Modified: +4 lines - Config test updates
```

**Pathfinder Repository Root Discovery** (4 files):

```
pathfinder/repo_root.go                   # NEW: 385 lines - FindRepositoryRoot implementation
pathfinder/repo_root_test.go              # NEW: 147 lines - Basic functionality tests
pathfinder/repo_root_security_test.go     # NEW: 497 lines - Security test suite
pathfinder/repo_root_bench_test.go        # NEW: 217 lines - Performance benchmarks
```

**Schema Validator** (1 file):

```
schema/validator.go                       # Modified: +173 lines - Path resolution fixes
```

**Documentation** (4 files):

```
logging/README.md                         # Modified: +150 lines - Redaction docs
pathfinder/README.md                      # Modified: +168 lines - Repository root docs
CHANGELOG.md                              # Updated with v0.1.15 entry
RELEASE_NOTES.md                          # Updated with v0.1.15 details
README.md                                 # Added logging and pathfinder package sections
```

**Crucible Dependency Update** (7 files):

```
go.mod                                    # Updated to Crucible v0.2.16
go.sum                                    # Updated with v0.2.16 hashes
.goneat/ssot-consumer.yaml                # Updated to v0.2.16 ref
.goneat/ssot/provenance.json              # Updated provenance tracking
.crucible/metadata/metadata.yaml          # Updated metadata
VERSION                                   # Updated to 0.1.15
docs/crucible-go/standards/observability/logging.md  # +193 lines
docs/crucible-go/standards/library/extensions/pathfinder.md  # +338 lines
docs/crucible-go/decisions/ADR-0012-schema-ref-ids.md  # NEW: 44 lines
schemas/crucible-go/logging/v1.0.0/logger-config.schema.json  # Updated
schemas/crucible-go/devsecops/v1.0.0/devsecops-module-entry.schema.json  # NEW: 117 lines
config/crucible-go/taxonomy/devsecops/modules/v1.0.0/modules.yaml  # NEW: 46 lines
config/crucible-go/taxonomy/library/platform-modules/v1.0.0/modules.yaml  # Updated: +45 lines
config/crucible-go/taxonomy/metrics.yaml  # Updated: +2 lines
```

**Total**: 27 files changed, +2,905 lines, -85 lines (6 new files, 21 updates)

## Breaking Changes

**None** - Fully backward compatible with v0.1.14.

- All logging configurations work without changes
- Legacy `name`→`type` and `order`→`priority` fields automatically mapped
- Redaction middleware is opt-in (no behavioral changes unless configured)
- Repository root discovery is additive (doesn't affect existing pathfinder APIs)

## Migration Guide

### From v0.1.14

No migration required. This release only adds functionality without changing existing APIs.

### Adopting Redaction Middleware

If you want to enable automatic PII/secrets redaction:

**Quick Start (Defaults)**:

```go
// Replace existing logger creation
// Before:
logger, err := logging.BundleStructured()

// After:
logger, err := logging.BundleStructuredWithRedaction()
```

**Custom Configuration**:

```go
// Define custom redaction rules
redactionConfig := logging.RedactionConfig{
    Patterns: []string{
        `\bAKIA[0-9A-Z]{16}\b`,  // AWS access keys
        `\bgh[ps]_[a-zA-Z0-9]{36}\b`,  // GitHub tokens
    },
    Fields: []string{"internal_token", "db_password"},
    ReplacementMode: "hash",  // Traceable via hash prefix
}

logger, err := logging.New(logging.LoggingConfig{
    Profile: "STRUCTURED",
    Middleware: []logging.MiddlewareConfig{
        logging.WithRedaction(redactionConfig),
    },
})
```

### Using Repository Root Discovery

If you need repository context for tooling:

```go
import "github.com/fulmenhq/gofulmen/pathfinder"

// Find repository root from any subdirectory
rootPath, err := pathfinder.FindRepositoryRoot(".")
if err != nil {
    if errors.Is(err, pathfinder.ErrRepositoryNotFound) {
        // Handle case where no repository markers found
    }
    log.Fatal(err)
}

// Use root path for schema loading, config resolution, etc.
schemaPath := filepath.Join(rootPath, "schemas", "myschema.json")
```

## Quality Metrics

- ✅ **Test Coverage**: All tests passing (36 pathfinder tests + existing suite)
- ✅ **Spec Compliance**: Crucible v0.2.16 fully satisfied
- ✅ **Cross-Language Audit**: Aligned with tsfulmen v0.1.9 (symlink loop detection)
- ✅ **Lint Health**: 100% (0 issues)
- ✅ **Precommit Health**: 100% (0 issues)
- ✅ **Performance**: All operations well under spec targets
- ✅ **Backward Compatibility**: 100% for logging configurations

## Known Limitations

### Logging Redaction Middleware

1. **Regex Performance**: Complex patterns may impact logging performance (use cautiously in hot paths)
2. **Deep Nesting**: Redaction only applies to top-level context fields (not deeply nested objects)
3. **Binary Data**: No redaction for binary log attachments (only string fields)

### Pathfinder Repository Root Discovery

1. **Symlink Performance**: Following symlinks adds overhead (disabled by default)
2. **Network Mounts**: Performance may vary on network filesystems
3. **Windows UNC Paths**: Limited testing on UNC path boundaries

## Future Roadmap

### v0.1.17 (Released)

HTTP Server Metrics Middleware - Production-Ready Performance

- **HTTP Metrics**: Complete implementation of all 5 HTTP metrics from Crucible v0.2.18 taxonomy
- **Performance**: ~21% overhead with tag pooling and optimized allocations
- **Route Normalization**: UUID and numeric segment normalization to prevent cardinality explosion
- **Framework Integration**: Chi, Gin, and net/http support

### v0.1.18 (Next)

Potential enhancements:

- **Logging**: Deep object redaction, custom redactor functions, performance metrics
- **Pathfinder**: Repository metadata caching, custom marker predicates
- **Schema**: Enhanced error messages with suggestions

### v0.2.0 (Major)

Breaking changes and major features:

- **Logging**: Structured middleware configuration format (breaking)
- **Pathfinder**: Async file discovery, streaming results
- **Schema**: Schema composition and inheritance

## Upgrade Instructions

### Standard Upgrade

```bash
# Update go.mod
go get github.com/fulmenhq/gofulmen@v0.1.15

# Verify update
go list -m github.com/fulmenhq/gofulmen
# Should show: github.com/fulmenhq/gofulmen v0.1.15

# Run tests to ensure compatibility
go test ./...
```

### With Crucible Sync

If your project uses Crucible assets directly:

```bash
# Update gofulmen
go get github.com/fulmenhq/gofulmen@v0.1.15

# Sync Crucible assets (if using goneat)
make sync

# Verify Crucible version
go list -m github.com/fulmenhq/crucible
# Should show: github.com/fulmenhq/crucible v0.2.16
```

## Verification

### Post-Upgrade Checklist

- [ ] Run `go test ./...` to verify all tests pass
- [ ] Check `go list -m github.com/fulmenhq/gofulmen` shows v0.1.15
- [ ] Check `go list -m github.com/fulmenhq/crucible` shows v0.2.16 (if using Crucible)
- [ ] Run `make lint` to verify code quality
- [ ] Run `make precommit` to verify formatting and static analysis
- [ ] Review new logging middleware documentation in `logging/README.md`
- [ ] Review new pathfinder features in `pathfinder/README.md`

### Testing New Features

Verify logging redaction works correctly:

```bash
# Run logging middleware tests
go test -v ./logging/... -run TestRedaction

# Should show redaction tests passing
```

Verify repository root discovery works correctly:

```bash
# Run pathfinder repository root tests
go test -v ./pathfinder/... -run TestFindRepositoryRoot

# Should show 36 tests passing (9 basic + 17 security + 10 benchmarks)
```

## Support & Feedback

### Documentation

- **Logging README**: `logging/README.md` - Redaction middleware guide
- **Pathfinder README**: `pathfinder/README.md` - Repository root discovery guide
- **Crucible Logging Standard**: `docs/crucible-go/standards/observability/logging.md`
- **Crucible Pathfinder Extension**: `docs/crucible-go/standards/library/extensions/pathfinder.md`

### Reporting Issues

Found a bug or have a feature request?

1. Check existing issues: https://github.com/fulmenhq/gofulmen/issues
2. Create new issue with:
   - Gofulmen version: v0.1.15
   - Crucible version: v0.2.16
   - Go version: `go version` output
   - Minimal reproduction case

### Community

- **Maintainers**: See `MAINTAINERS.md`
- **Contributing**: See `CONTRIBUTING.md`
- **Agent Collaboration**: See `AGENTS.md` for AI agent guidelines

## Release Artifacts

### Git Tag

```bash
git tag v0.1.15
git push origin v0.1.15
```

### GitHub Release

Release notes and artifacts available at:
https://github.com/fulmenhq/gofulmen/releases/tag/v0.1.15

### Checksums

Verify module integrity:

```bash
go mod download github.com/fulmenhq/gofulmen@v0.1.15
go mod verify
```

## Credits

### Contributors

This release was a collaborative effort between:

- **Foundation Forge** (AI Agent) - Logging middleware, pathfinder root discovery, schema fixes, documentation
- **@3leapsdave** (Human Supervisor) - Architecture review, cross-language audit, security validation, release approval

### Acknowledgments

- **Crucible Team** - v0.2.16 release with logging middleware and pathfinder specifications
- **Cross-Language Audit** - tsfulmen v0.1.9 spec review identified symlink loop detection gap
- **Security Testing** - Comprehensive test suite ensures safety boundaries enforced

## Appendix

### Logging Middleware Compliance

| Requirement                     | Status | Implementation                                |
| ------------------------------- | ------ | --------------------------------------------- |
| Schema-compliant configuration  | ✅     | `config.go` MiddlewareConfig, RedactionConfig |
| Pattern-based redaction         | ✅     | `middleware_redaction_v2.go`                  |
| Field-based redaction           | ✅     | `middleware_redaction_v2.go`                  |
| Replacement modes (text/hash)   | ✅     | `middleware_redaction_v2.go`                  |
| Default patterns for common PII | ✅     | API keys, passwords, SSNs, credit cards       |
| Helper functions                | ✅     | `helpers.go` WithRedaction, bundle helpers    |
| Backward compatibility          | ✅     | `logger.go` name→type, order→priority         |
| Opt-in design                   | ✅     | No changes unless configured                  |

**Compliance**: 8/8 requirements met (100%)

### Pathfinder Security Compliance

| Requirement                 | Status | Implementation                              |
| --------------------------- | ------ | ------------------------------------------- |
| Home directory boundary     | ✅     | Default ceiling at $HOME                    |
| Configurable boundaries     | ✅     | WithBoundary(), WithStrictBoundary()        |
| Max depth limit             | ✅     | Default 10, WithMaxDepth()                  |
| Filesystem root detection   | ✅     | /, C:\, UNC path detection                  |
| Symlink loop detection      | ✅     | TRAVERSAL_LOOP error, visited tracking      |
| Multi-tenant isolation      | ✅     | Boundary enforcement prevents leaks         |
| Container escape prevention | ✅     | Boundaries block upward traversal           |
| Cross-language parity       | ✅     | Aligned with tsfulmen v0.1.9                |
| Performance targets         | ✅     | <30µs (spec: <5-20ms)                       |
| Comprehensive testing       | ✅     | 36 tests (9 basic + 17 security + 10 bench) |

**Compliance**: 10/10 requirements met (100%)

### Performance Benchmarks

Measured on Apple M1 Max, 64GB RAM, macOS Sonoma 14.6.1:

| Operation             | Duration | Spec Target | Performance   |
| --------------------- | -------- | ----------- | ------------- |
| Immediate match       | 6.0µs    | <5ms        | 830x faster   |
| 3 levels up           | 13.6µs   | <5ms        | 367x faster   |
| 5 levels up           | 18.0µs   | <20ms       | 1,111x faster |
| Max depth (10 levels) | 30.0µs   | <20ms       | 666x faster   |

**Note**: Benchmarks are indicative. Real-world performance varies by filesystem characteristics and directory depth.

---

**Release Date**: 2025-11-16  
**Released By**: Foundation Forge (AI Agent) under supervision of @3leapsdave  
**Crucible Version**: v0.2.16  
**License**: MIT
