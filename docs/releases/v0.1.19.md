# Gofulmen v0.1.19 Release Notes

**Release Date**: 2025-11-19  
**Release Type**: Critical Bug Fix + Process Improvement  
**Status**: ✅ Released

## Overview

This release fixes the v0.1.18 Crucible version mismatch and implements guardrails to prevent future occurrences. The mismatch caused `go.mod` to require v0.2.18 while embedded assets came from v0.2.19, primarily affecting users of Crucible's DevSecOps secrets schema.

## Critical Fix

### Crucible Version Mismatch (v0.1.18)

**Issue**: go.mod required `github.com/fulmenhq/crucible v0.2.18` but synced assets were from v0.2.19

**Impact**:

- Version reporting via `crucible.GetVersionString()` showed incorrect version
- DevSecOps secrets schema users got v0.2.19 documentation but v0.2.18 runtime behavior
- Potential runtime errors if schemas/APIs changed between versions

**Root Cause**: Sync process updated `.goneat/ssot-consumer.yaml` and ran `make sync` but forgot to run `go get github.com/fulmenhq/crucible@v0.2.19`

**Fix**:

- Updated go.mod from v0.2.18 to v0.2.19
- Updated provenance timestamp via `make sync`
- All three synchronization points now aligned: ssot-consumer.yaml, provenance.json, go.mod

## Guardrails Implemented

### 1. Automated Detection: `TestCrucibleVersionMatchesMetadata`

New test that fails CI/builds when go.mod and metadata versions disagree.

**Implementation**:

- Parses go.mod using `golang.org/x/mod/modfile` (no shell dependencies)
- Parses `.crucible/metadata/metadata.yaml` to extract synced Crucible version
- Normalizes versions to handle format differences ("v0.2.19" vs "0.2.19")
- Beautiful error message using `ascii.DrawBox()` shows exact mismatch and remediation steps
- **Dogfoods gofulmen**: Uses `pathfinder.FindRepositoryRoot()` for repo discovery

**Integration**:

- Runs as part of `make check-all`
- Runs as part of `go test ./...`
- Runs in CI on every PR
- Blocks releases with version mismatches

### 2. Automated Workflow: `make crucible-update VERSION=v0.2.X`

Single command that atomically updates all three synchronization points.

**What it does**:

1. Updates `.goneat/ssot-consumer.yaml` ref via sed
2. Runs `make sync` to update provenance timestamp
3. Runs `go get github.com/fulmenhq/crucible@<version>` + `go mod tidy`
4. Runs verification test to confirm success
5. Shows clear next steps for developer

**Benefits**:

- Atomic operation prevents partial updates
- Self-documenting with progress messages
- Automated verification catches mistakes immediately
- Clear guidance for next steps

### 3. Manual Verification Guide (ADR-0007)

Quick 3-point check for code reviewers:

```bash
# 1. Check sync ref
grep "ref:" .goneat/ssot-consumer.yaml  # Expected: ref: v0.2.19

# 2. Check go.mod
grep "github.com/fulmenhq/crucible" go.mod  # Expected: v0.2.19

# 3. Check metadata
grep "version:" .crucible/metadata/metadata.yaml | head -2  # Expected: 0.2.19 (no 'v')
```

All three should show the same semantic version (ignoring 'v' prefix differences).

**Deep verification** (optional):

```bash
# Check provenance for sync timestamp and commit hash
jq '.sources[] | select(.name=="crucible") | {version, commit, generated_at}' \
  .goneat/ssot/provenance.json
```

## Changes

### Fixed

- Crucible version mismatch: go.mod v0.2.18 → v0.2.19 (aligns with embedded assets)
- Updated provenance timestamp to reflect current sync state

### Added

- `crucible/version_guard_test.go` - Guardrail test (152 lines)
  - Uses `pathfinder.FindRepositoryRoot()` for repo root discovery
  - Uses `ascii.DrawBox()` for formatted error messages
  - Normalizes version comparison to handle format differences
- `make crucible-update` - Atomic Crucible update workflow (30 lines in Makefile)
- `docs/development/adr/ADR-0007-crucible-version-synchronization.md` - Process documentation (350 lines)

### Changed

- Dependency: Added `golang.org/x/mod v0.30.0` for go.mod parsing in guardrail test

## Files Changed

```
crucible/version_guard_test.go                     # NEW: 152 lines - Guardrail test
docs/development/adr/ADR-0007-crucible-version-synchronization.md  # NEW: 350 lines - ADR
Makefile                                           # +30 lines: crucible-update target
go.mod                                             # crucible v0.2.18 → v0.2.19, +golang.org/x/mod
go.sum                                             # Updated checksums
.goneat/ssot/provenance.json                       # Updated timestamp
.crucible/metadata/metadata.yaml                   # Updated timestamp
VERSION                                            # v0.1.19
docs/crucible-go/guides/consuming-crucible-assets.md  # +112 lines: Practical examples
```

**Total**: 9 files changed, +644 insertions, -24 deletions (2 new files, 7 updates)

## Testing

- ✅ `TestCrucibleVersionMatchesMetadata` PASSES (versions now match)
- ✅ `make check-all` PASSES (all quality checks)
- ✅ No regressions in test suite
- ✅ Manual 3-point verification confirms alignment

## Impact

### For All Users

- ✅ Correct Crucible version reporting via `crucible.GetVersionString()`
- ✅ Runtime behavior matches embedded documentation
- ✅ Future releases protected by guardrail test

### For DevSecOps Users

- ✅ Correct DevSecOps secrets schema version (v0.2.19)
- ✅ Documentation matches runtime behavior
- ✅ No schema/runtime version discrepancies

### For Contributors

- ✅ Simple workflow: `make crucible-update VERSION=v0.2.X`
- ✅ Automated verification catches mistakes before commit
- ✅ Clear documentation in ADR-0007
- ✅ Manual verification guide for code reviews

## Future Workflow

When Crucible releases a new version:

```bash
# Single atomic command
make crucible-update VERSION=v0.2.20

# Then verify and commit
make check-all
git diff  # Review changes
git commit  # Commit with attribution
```

## Lessons Learned

This is the **second time** this mistake was made (v0.1.17 and v0.1.18), proving that:

1. **Process > Memory**: Automated workflows prevent human error better than documentation
2. **Fail Fast**: Tests that catch mistakes before release are invaluable
3. **Dogfooding Works**: Using our own libraries (pathfinder, ASCII) improved test quality
4. **Clear Error Messages**: Investing in formatted, actionable errors pays off immediately

## Dependencies

- **Go**: 1.21+ (unchanged)
- **Crucible**: v0.2.18 → v0.2.19
- **New**: golang.org/x/mod v0.30.0 (for go.mod parsing)

## Migration

No migration required for users. This is a bug fix that corrects internal version alignment. Users should simply upgrade to v0.1.19.

If you were using v0.1.18 with DevSecOps secrets:

- Documentation now correctly matches runtime behavior
- No code changes needed in your application
- Just update your gofulmen dependency to v0.1.19

## Related Resources

- [Crucible v0.2.19 Release](https://github.com/fulmenhq/crucible/releases/tag/v0.2.19)
- [ADR-0007: Crucible Version Synchronization](../development/adr/ADR-0007-crucible-version-synchronization.md)
- [Feature Brief: Crucible Version Mismatch Fix](.plans/active/v0.1.19/crucible-version-mismatch-fix.md)
