# Release Notes: v0.1.8

**Release Date**: November 3, 2025  
**Release Type**: Major Feature Addition (Schema Export + Exit Codes)  
**Status**: ✅ Ready for Release (pending Crucible v0.2.4)

## Overview

Version 0.1.8 adds two major features: comprehensive schema export utilities for vendoring Crucible schemas with full provenance tracking, and complete exit codes integration providing 54 standardized exit codes with metadata, platform detection, and compatibility layers.

## Features

### Feature 1: Schema Export Utilities

Export Crucible schemas with full provenance tracking for vendoring and distribution.

#### API Package (`schema/export`)

**Core Functions:**

- `Export(ctx, ExportOptions)` - Main export function with validation, formatting, and safety
- `ValidateExportedSchema(schemaID, filePath)` - Verify exported schemas match SSOT
- `NewExportOptions(schemaID, outPath)` - Create options with sensible defaults

**Export Options:**

- `SchemaID` (required) - Crucible schema identifier
- `OutPath` (required) - Destination file path
- `Format` - JSON or YAML (auto-detected from extension)
- `IncludeProvenance` (default: true) - Include metadata tracking
- `ProvenanceStyle` (default: object) - Object, comment, or none
- `ValidateSchema` (default: true) - Validate before export
- `Overwrite` (default: false) - Overwrite protection
- `IdentityProvider` - Optional app identity (.fulmen/app.yaml)

**Provenance Metadata:**

```json
{
  "x-crucible-source": {
    "schema_id": "observability/logging/v1.0.0/log-event.schema.json",
    "crucible_version": "2025.10.5",
    "gofulmen_version": "v0.1.8",
    "git_revision": "d466ade",
    "exported_at": "2025-11-03T22:30:42Z",
    "identity": {
      "vendor": "fulmenhq",
      "binary": "gofulmen"
    }
  }
}
```

**Provenance Styles:**

- **Object** (default): `x-crucible-source` top-level field in JSON
- **Comment**: Compact `$comment` field format
- **YAML Front-Matter**: Commented metadata before `---` separator

**Safety Features:**

- Path validation with absolute path resolution
- Overwrite protection (requires --force)
- Parent directory auto-creation
- Graceful error handling with proper exit codes

**Payload Parity:**

- `compareSchemaPayloads()` strips provenance and verifies byte-for-byte match with SSOT
- Ensures exported schemas match embedded Crucible schemas exactly
- Catches drift between exported and source schemas

#### CLI Tool (`cmd/gofulmen-export-schema`)

**Required Flags:**

- `--schema-id` - Crucible schema identifier
- `--out` - Output file path

**Optional Flags:**

- `--format` - Output format (json|yaml, default: auto-detect)
- `--provenance-style` - Provenance style (object|comment|none)
- `--no-provenance` - Disable provenance metadata
- `--no-validate` - Skip schema validation
- `--force` - Overwrite existing files

**Exit Codes:**

- `0` - Success
- `20` - Schema not found (ExitConfigInvalid)
- `40` - Invalid arguments (ExitInvalidArgument)
- `54` - File write error (ExitFileWriteError)
- `60` - Validation failure (ExitDataInvalid)

**Examples:**

```bash
# Export with provenance
gofulmen-export-schema \
    --schema-id=observability/logging/v1.0.0/log-event.schema.json \
    --out=vendor/crucible/schemas/logging-event.schema.json

# Export as YAML with comment-style provenance
gofulmen-export-schema \
    --schema-id=terminal/v1.0.0/schema.json \
    --out=schema.yaml \
    --format=yaml \
    --provenance-style=comment

# Export without provenance
gofulmen-export-schema \
    --schema-id=terminal/v1.0.0/schema.json \
    --out=schema.json \
    --no-provenance
```

#### App Identity Integration

**Default Identity Provider:**

- Auto-discovers `.fulmen/app.yaml` walking up directory tree
- Graceful fallback (returns nil, not error) when file missing
- Supports both `binary` and `name` fields (name as fallback)
- Reads `vendor` and `binary` for provenance metadata

**Example `.fulmen/app.yaml`:**

```yaml
vendor: fulmenhq
binary: gofulmen
```

#### Quality & Testing

**Unit Tests (28 total):**

- Export success (JSON, YAML)
- Format detection
- Provenance styles (object, comment, none)
- Overwrite protection
- Path safety
- Options validation
- Payload comparison (strips provenance, verifies match)
- Identity provider (7 test cases)

**CLI Integration Tests (6 total):**

- Success case
- Help output
- Missing required arguments
- Overwrite protection
- Format variants
- Provenance styles

**Quality Metrics:**

- ✅ 100% lint health (Excellent rating)
- ✅ All tests pass
- ✅ Payload parity verified
- ✅ Exit codes use proper error sentinels

#### Implementation Files

**Core Package (`schema/export/`):**

- `export.go` (179 lines) - Main Export() + compareSchemaPayloads()
- `options.go` (164 lines) - ExportOptions with validation
- `provenance.go` (84 lines) - Metadata builder using foundry.GofulmenVersion()
- `format.go` (102 lines) - JSON/YAML formatters
- `safety.go` (69 lines) - Path validation, error sentinels
- `identity.go` (94 lines) - Default provider with .fulmen/app.yaml discovery
- `export_test.go` (507 lines) - Comprehensive unit tests
- `identity_test.go` (180 lines) - Identity provider tests

**CLI Tool (`cmd/gofulmen-export-schema/`):**

- `main.go` (196 lines) - CLI with errors.Is() exit code mapping
- `main_test.go` (169 lines) - CLI integration tests

**Total**: 10 files, ~1,744 lines

#### Documentation

- `docs/schema/export.md` (223 lines) - Complete API and CLI guide
- `README.md` - Usage examples added
- `Makefile` - `export-schema` and `export-schema-example` targets

#### Makefile Targets

```bash
# Export with custom schema
make export-schema SCHEMA_ID=observability/logging/v1.0.0/log-event.schema.json OUT=output.json

# Export example schema
make export-schema-example
```

---

### Feature 2: Foundry Exit Codes Integration

Complete implementation of standardized exit codes from Crucible v0.2.3 catalog.

#### Exit Code Constants (54 total)

**Re-exported from Crucible:**

- `ExitSuccess` (0), `ExitFailure` (1)
- Networking: `ExitPortInUse` (10), `ExitConnectionTimeout` (11), etc.
- Configuration: `ExitConfigInvalid` (20), `ExitSsotVersionMismatch` (23), etc.
- Runtime: `ExitHealthCheckFailed` (30), `ExitDatabaseUnavailable` (32), etc.
- Signals: `ExitSignalTerm` (143), `ExitSignalInt` (130), etc. (POSIX only)

#### Metadata Access Layer

**Core Functions:**

- `GetExitCodeInfo(code int)` - Get metadata for specific exit code
- `LookupExitCode(name string)` - Find code by name
- `ListExitCodes()` - Get all codes with metadata
- `GetSimplifiedModeInfo(mode string)` - Get simplified mode mapping

**Metadata Structure:**

```go
type ExitCodeInfo struct {
    Code        int
    Name        string
    Category    string
    Description string
    MapsFrom    []int  // BSD codes that map to this
}
```

**Catalog Parsing:**

- Correct YAML parsing with `maps_from` field
- Efficient sorting with `sort.Ints()`
- Catalog-derived simplified modes (no hardcoded mappings)

#### Platform Detection

**Functions:**

- `SupportsSignalExitCodes()` - Returns false on Windows (except WSL)
- `GetPlatformInfo()` - Comprehensive metadata (GOOS, GOARCH, WSL status)

**WSL Detection:**

- Checks `WSL_DISTRO_NAME` environment variable
- Checks `WSL_INTEROP` environment variable
- Allows signal codes on WSL (Linux-like behavior)

#### Provenance Reporting

**Version Functions:**

- `GofulmenVersion()` - Returns "v0.1.8" (from foundry/version.go)
- `CrucibleVersion()` - Returns Crucible module version
- `ExitCodesVersion()` - Returns catalog version from Crucible
- `GetProvenanceInfo()` - Returns structured provenance

**No Hardcoded Values:**

- All versions sourced from Crucible constants
- `foundry/version.go` uses const `version = "0.1.8"` matching VERSION file

#### Simplified Mode Mapping

**MapToSimplified(code int, mode string):**

**Basic Mode (3 codes):**

- 0 = success
- 1 = error
- 2 = usage_error

**Severity Mode (8 codes):**

- 0 = success
- 1 = user_error
- 2 = config_error
- 3 = runtime_error
- 4 = system_error
- 5 = security_error
- 6 = test_failure
- 7 = observability_error

**Catalog-Derived:**

- Reads from `catalog.SimplifiedModes` (not hardcoded)
- Handles all 8 severity levels correctly

#### BSD Compatibility

**Functions:**

- `MapToBSD(fulmenCode int)` - Maps Fulmen codes to BSD sysexits.h
- `MapFromBSD(bsdCode int)` - Reverse mapping from BSD to Fulmen
- `GetBSDCodeInfo(bsdCode int)` - Metadata for BSD exit codes

**Coverage:**

- All 16 standard BSD codes mapped (EX_OK through EX_CONFIG)
- Bidirectional mapping for interoperability

#### Quality Assurance

**Snapshot Parity Test:**

- Compares against `exit-codes.snapshot.json` from Crucible
- Verifies 54/54 codes (names, categories, descriptions)
- Automatic drift detection if catalog changes

**Test Coverage:**

- 100% API coverage
- Platform detection tests (Windows, macOS, Linux, WSL)
- BSD mapping tests
- Simplified mode tests

#### Implementation Files

**Core Package (`foundry/`):**

- `exit_codes.go` (18 lines) - Re-exported constants
- `exit_codes_metadata.go` (242 lines) - Metadata access layer
- `platform.go` (95 lines) - Platform detection
- `version.go` (72 lines) - Provenance reporting
- `simplified_modes.go` (98 lines) - Simplified mapping
- `bsd.go` (171 lines) - BSD compatibility
- `exit_codes_test.go` (259 lines) - Core API tests
- `exit_codes_snapshot_test.go` (186 lines) - Parity verification
- `platform_test.go` (125 lines) - Platform tests
- `simplified_modes_test.go` (147 lines) - Simplified tests
- `bsd_test.go` (135 lines) - BSD mapping tests

**Total**: 11 files, ~1,548 lines

---

## Dependencies

- **Crucible**: v0.2.3 (exit codes catalog, schemas)
- **Go**: 1.21+ (tested on 1.21, 1.22, 1.23)
- **External**: gopkg.in/yaml.v3 (YAML parsing)

## Breaking Changes

None. All changes are additive.

## Migration Guide

No migration required. New features are opt-in.

**To use schema export:**

```go
import "github.com/fulmenhq/gofulmen/schema/export"
```

**To use exit codes:**

```go
import "github.com/fulmenhq/gofulmen/foundry"
os.Exit(foundry.ExitConfigInvalid)
```

## Known Issues

- Schema validation may fail for schemas with unresolved `$ref` links
  - Use `--no-validate` flag or `ValidateSchema: false` option
  - Payload parity still verified regardless of validation

## Version Information

- **Gofulmen**: 0.1.8
- **Crucible**: v0.2.3 (2025.10.5)
- **Go Versions Tested**: 1.21, 1.22, 1.23

## Files Changed

- **New**: 21 files (10 schema export + 11 exit codes)
- **Modified**: 8 files (CHANGELOG, README, Makefile, crucible.go, etc.)
- **Total Lines**: ~3,290 lines added

## Quality Metrics

- ✅ 100% lint health (0 issues)
- ✅ All 34 tests passing (28 unit + 6 CLI)
- ✅ `make check-all` clean
- ✅ Pre-commit hooks passed
- ✅ CI ready

## Summary

Version 0.1.8 delivers two enterprise-grade features:

1. **Schema Export** - Production-ready vendoring solution with provenance tracking, payload parity verification, app identity integration, and proper error handling

2. **Exit Codes** - Complete standardization layer with 54 codes, metadata access, platform detection, simplified mappings, and BSD compatibility

Both features include comprehensive documentation, extensive test coverage, and follow all Fulmen standards.

**Ready for production use.** ✅

## Next Steps

1. Await Crucible v0.2.4 release (pending)
2. Tag v0.1.8 after Crucible update
3. Publish to pkg.go.dev
4. Update downstream projects (forge-workhorse-groningen, etc.)
